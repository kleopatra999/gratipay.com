import requests

from aspen import Response
from gratipay.utils import markdown, truncate
from gratipay.models.package import Package
from gratipay.models.package.emails import PRIMARY, VERIFIED, UNVERIFIED, UNLINKED, OTHER

[---]

package_name = request.path['package']
package = Package.from_names('npm', package_name)
if package is None:
    raise Response(404)
elif package.team:
    website.redirect(package.team.url_path)

page_id = "package"
suppress_sidebar = True
banner = package_name
[---]
{% extends "templates/base.html" %}

{% block banner %}
<a class="elsewhere" href="{{ package.remote_human_url }}">
    <div class="avatar">
        <img class="avatar" src="{{ website.asset('package-default-large.png') }}" />
        <img class="platform" src="{{ website.asset('npm-n.png') }}" />
    </div>
    {{ super() }}
</a>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        Gratipay.packages.init();
    });
</script>
{{ super() }}
{% endblock %}

{% block content %}

{% if package.description %}
<p class="description important-thing-at-the-top{% if len(package.description) > 256 %} long{% endif %}">{{ package.description }}</p>
{% else %}
<p class="note important-thing-at-the-top">{{ _("No description available.") }}</p>
{% endif %}

<p class="instructions">
    {{ _( 'Apply to accept payments for the {package_link} npm package:'
        , package_link=('<a href="' + package.remote_human_url + '">' + package_name + '</a>')|safe
         ) }}
 </p>

{% if user.ANON %}
    <div class="button-wrapper">
        {% include "templates/sign-in-using.html" %}
    </div>
{% else %}
    {% if len(package.emails) == 0 %}
    <p class="note">{{ _("No email addresses on file.") }}</p>
    {% else %}
    <input type="hidden" name="package_id" value="{{ package.id }}">
    <ul class="package-emails gratipay-dropdown">
    {% set classified = package.classify_emails_for_participant(user.participant) %}
    {% for i, (email, group) in enumerate(classified, start=1) %}
        <li{% if i == 1 %} class="selected"{% endif %}>
            <input type="radio" name="email" value="{{ email }}" id="email-{{i}}"
                   {% if i == 1 %}checked{% endif %}>
            <div class="listing-wrapper">
                <label class="listing-name" for="email-{{ i }}">{{ email }}</label>
                <div class="listing-details">
                    <span class="i">{{ i }}</span>
                    {% if group == PRIMARY %}
                    <span>&middot; {{ _('Your primary email address') }}</span>
                    {% elif group == VERIFIED %}
                    <span>&middot; {{ _('Already linked to your account') }}</span>
                    {% elif group in (UNVERIFIED, UNLINKED) %}
                    <span>&middot; {{ _('Ready to link') }}</span>
                    {% elif group == OTHER %}
                    <span>&middot; {{ _('Already linked to another account') }}</span>
                    {% endif %}
                </div>
            </div>
        </li>
    {% endfor %}
    </ul>

    <div class="button-wrapper">
        <button type="submit" class="apply selected large">
            {{ _('Apply to accept payments') }}
        </button>
    </div>
    {% endif %}
    <p class="note">{{ _( 'Addresses are from {a}{code}maintainers{_code}{_a}.'
                        , a=('<a href="' + package.remote_api_url + '">')|safe
                        , _a='</a>'|safe
                        , code='<code>'|safe
                        , _code='</code>'|safe
                         ) }}</p>
    <p class="note">{{ _( 'Out of date? Update {a}at npm{_a} and refresh.'
                        , a=('<a href="' + package.remote_human_url + '">')|safe
                        , _a='</a>'|safe
                         ) }}</p>
{% endif %}
{% endblock %}
